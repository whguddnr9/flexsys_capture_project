<!-- 
    작성자 : 조형욱
    작성일 : 20210722

    목표 : canvas가 아닌 div를 이용한 상자 만들기.

    수정사항 :
    [20210722]  div를 이용한 시스템 구성 틀 작성
                div를 생성해서 상자 틀을 만든다. 
    [20210723]  마우스 클릭 이벤트 오류 해결중
    [20210724]  마우스 드래그 영역 오류 해결중
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <script  src="http://code.jquery.com/jquery-latest.min.js"></script>
    
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.min.js"></script>

    <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/jqueryui/1.12.1/jquery-ui.css">
    <link rel="stylesheet" href="./div_test.css">


</head>
<body>
    <button id="make" class = "div_btn">takeScreenShot</button>
    <button id="draw" class = "draw_btn">move div</button>
    <!-- 드래그 가능한 DIV -->

     <div class="mydiv" id="thisdiv">
        <!-- 헤더를 누르면 부속 요소들을 옮길 수 있음" -->
        <div class="mydivheader" id="thisdivheader">Click here to move</div>
        <p>Move</p>
    </div>     

    <canvas id="fake"></canvas>
    <button id="cake" class = "screen_btn">takeScreenShot</button>
    
</body>
<!-- 해야할것, div 생성하는데 id  값 다르게 생성하는거 해야함. -->

<script>
    var i=1;

    //박스를 추가하는 함수.
    function add() {
        
        var frame_id    =  "frame"+i;
        var head_id     =  "frame"+i+"header";

        var $frame_div   =  $("<div></div>").addClass("mydiv");
        var $head_div    =  $("<div>this is header</div>").addClass("mydivheader");


        $frame_div.attr('id',frame_id);
        $head_div.attr('id',head_id);
        

        $("body").append($frame_div);
        $("#frame"+i).append($head_div);

        console.log("frame id :"+frame_id);
        console.log("head id :"+head_id);
        
        i++;

    }

    function check_move(){
    
        $('.mydiv').mouseover(function() {
            var click_id = $(this).attr('id');
            console.log(click_id);
            console.log("check1");
            
            dragElement(document.getElementById(click_id));
            
            $("#"+click_id).resizable({
                //함께 커질영역 
                //alsoResize:".mydivheader",
                //비율유지
                aspectRatio: false,
                //마우스 hover 아닐때 핸들러 숨기기
                autoHide: true,
                //minHeight, maxHeight, minWidth, maxWidth 최소,최대 크기지정 
            });
            function dragElement(elmnt) {
                var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                if (document.getElementById(elmnt.id + "header")) {
                    // 헤더에 dragmousedown 이벤트 등록
                    document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
                } else {
                    //다른곳을 눌렀을 경우
                    elmnt.onmousedown = dragMouseDown;
                }

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    //눌렀을때의 좌표값
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // 드래그 이벤트 등록
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // 드래그한 위치
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    // 객체의 새 위치 등록
                    elmnt.style.top  = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    //마우스를 땠을때 변수들 초기화
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }
        })     
    }
    $(document).ready(function() {
        $("#draw").on("click", function() {

            // add();

                //드래그 가능한 div 만들기. body 에서 mydiv 객체 가지고옴

                // div의 id 값을 가지고 와 해당div 움직임.
/* 
                $('.mydiv').mouseover(function() {
                    var click_id = $(this).attr('id');
                    console.log(click_id);
                    console.log("check1");
                    
                    dragElement(document.getElementById(click_id));
                    
                    $("#"+click_id).resizable({
                        //함께 커질영역 
                        //alsoResize:".mydivheader",
                        //비율유지
                        aspectRatio: false,
                        //마우스 hover 아닐때 핸들러 숨기기
                        autoHide: true,
                        //minHeight, maxHeight, minWidth, maxWidth 최소,최대 크기지정 
                    });
                    function dragElement(elmnt) {
                        var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                        if (document.getElementById(elmnt.id + "header")) {
                            // 헤더에 dragmousedown 이벤트 등록
                            document.getElementById(elmnt.id + "header").onmousedown = dragMouseDown;
                        } else {
                            //다른곳을 눌렀을 경우
                            elmnt.onmousedown = dragMouseDown;
                        }

                        function dragMouseDown(e) {
                            e = e || window.event;
                            e.preventDefault();
                            //눌렀을때의 좌표값
                            pos3 = e.clientX;
                            pos4 = e.clientY;
                            document.onmouseup = closeDragElement;
                            // 드래그 이벤트 등록
                            document.onmousemove = elementDrag;
                        }

                        function elementDrag(e) {
                            e = e || window.event;
                            e.preventDefault();
                            // 드래그한 위치
                            pos1 = pos3 - e.clientX;
                            pos2 = pos4 - e.clientY;
                            pos3 = e.clientX;
                            pos4 = e.clientY;
                            // 객체의 새 위치 등록
                            elmnt.style.top  = (elmnt.offsetTop - pos2) + "px";
                            elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                        }

                        function closeDragElement() {
                            //마우스를 땠을때 변수들 초기화
                            document.onmouseup = null;
                            document.onmousemove = null;
                        }
                    }
                })  */       
        });
    });

    //마우스 클릭 이벤트
    window.onload = function () {
        //버튼 눌렀을때 이벤트 등록
        document.getElementById("draw").addEventListener("click", function (e) {
            document.querySelector("body").classList.add("edit_cursor");

        });
    }    
    //상자 그리는 함수
    function draw(e) {
        var startX, startY;
        var height  = window.innerHeight;
        var width   = window.innerWidth;

        //영역을 표시할 div 객체
        var $createFrame = document.createElement("div");
        $createFrame.id="createframe";
        $createFrame.style.borderWidth = "0 0 " + height + "px 0";
        var $createBox_Frame = $("<div>frame</div>");
        var $createBox = $("<div></div>");

        //
        var $movebox = document.createElement("div");
        //

        var selectArea =false;

        //
        $movebox.id = "move_Box";
        //

        $createBox_Frame.attr('id',"frame"+i);
        $createBox.attr('id',"frame"+i+"header");

        i++;

        document.querySelector("body").appendChild($createFrame);
        document.querySelector("body").appendChild($movebox);

        $("body").append($createBox_Frame);
        $("#frame"+i).append($createBox);

        var body = document.querySelector('body');

        var mousedown = function(e){
            console.log("mousedown");
            //다른 이벤트들 무시해 기능이 중첩되지 않게
            e.preventDefault();
            selectArea = true;

            startX = e.clientX;
            startY = e.clientY;

/*             $createBox.css({
                'top' : startY,
                'left' : startX,
                'width' : 0,
                'height' : 0,
            }) */
            
            //같은 기능 중첩 방지
            body.removeEventListener("mousedown", mousedown);
        }

        body.addEventListener("mousedown", mousedown);

        var mouseup = function(e){
            console.log("mouseup");
            selectArea =false;

            body.removeEventListener("mousemove",mousemove);
            var x = e.clientX;
            var y = e.clientY;
            
            //그린 사각형의 크기 저장
            var top     = Math.min(y, startY);
            var left    = Math.min(x, startX);
            var width   = Math.max(x, startX) - left;
            var height  = Math.max(y, startY) - top;

            console.log(left,top,width,height);
            $createBox.css({
                'top' : top,
                'left' : left,
                'width' : width,
                'height' : height
            });
            $createBox_Frame.css({
                'top' : top,
                'left' : left,
                'width' : width,
                'height' : height
            });
            $movebox.style.top = top + "px";
                $movebox.style.left = left + "px";
                $movebox.style.width = width + "px";
                $movebox.style.height = height + "px";

            body.removeEventListener("mouseup", mouseup);
            // 마우스 커서 기본으로 변경 
            document.querySelector("body").classList.remove("edit_cursor");
            $createBox.addClass("mydivheader");
            $createBox_Frame.addClass("mydiv");
            $movebox.parentNode.removeChild($movebox);

            console.log("why??");


        }
        body.addEventListener("mouseup", mouseup);

        var mousemove = function(e) {
            var x = e.clientX;
            var y = e.clientY;

            var top     = Math.min(y, startY);
            var left    = Math.min(x, startX);
            var _width   = Math.max(x, startX) - left;
            var _height  = Math.max(y, startY) - top;
            
 
/*             $createBox.style.left = x;
            $createBox.style.top = y; */
            

            if(selectArea){
  
                var top = Math.min(y, startY);
                var right = width - Math.max(x, startX);
                var bottom = height - Math.max(y, startY);
                var left = Math.min(x, startX);
                console.log("selectArea: true");

                $createBox.css({
                    'top' : top,
                    'left' : left,
                    'width' : width,
                    'height' : height
                });
                $createBox_Frame.css({
                    'top' : top,
                    'left' : left,
                    'width' : width,
                    'height' : height
                });

                $movebox.style.top = top + "px";
                $movebox.style.left = left + "px";
                $movebox.style.width = _width + "px";
                $movebox.style.height = _height + "px";
                
            }
        }
        body.addEventListener("mousemove", mousemove);

    }

    //div 삭제할 함수.

    //저장할 객체. 객체에서 함수를 불러와 그린다. 
    class Box {
        constructor(left,top,width,height){
        }
    }
</script>

<script>
    $( document ).ready( function() {
      $( 'button.screen_btn' ).click( function() {
        $( '.screen_btn' ).hide();
      } );
    } );
</script>

<script>
  const canIRun  = navigator.mediaDevices.getDisplayMedia 

const takeScreenShot = async () => {
    const stream = await navigator.mediaDevices.getDisplayMedia({
      video: { mediaSource: 'screen' },
    })
    const track = stream.getVideoTracks()[0]
    const imageCapture = new ImageCapture(track)
    const bitmap = await imageCapture.grabFrame()
    track.stop()

    const canvas = document.getElementById('fake') 
    canvas.width = bitmap.width
    canvas.height = bitmap.height

    const context = canvas.getContext('2d')
    context.drawImage(bitmap, 0, 0, bitmap.width, bitmap.height)
    const image = canvas.toDataURL()

    const res = await fetch(image)
    const buff = await res.arrayBuffer()
    const file = [
      new File([buff], `photo_${new Date()}.png`, {
        type: 'image/png',
      }),
    ]
    return file 
}     

const button = document.getElementById('cake').onclick = () => canIRun ? takeScreenShot() : {}
</script>


<script>

</script>
</html>

<!-- 마우스를 눌렀을때 div로 창을 만들고, 마우스를 때면 그린 div객체를 삭제하고,
생성자를 이용해 객체를 만들어 마우스로 드래그 한 div 크기 그대로 다시 생성?

class 안에 method를 만들어 div 생성 코드 만들 것 

위치가 변경됬을 시? Box1.left = 11 이런식으로 변경?
-->