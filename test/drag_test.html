<!--
    작성자 : 조형욱
    작성일 : 20210710
    
    수정사항 : 
    [20210710] 기존 코드에서 상자 클릭 이벤트 작성
    [20210712] 새로운 코드를 작성하여 상자를 움직이는 코드 작성
    [20210713]  상자 움직이는 코드에 상자를 생성하는 코드 작성하여 병합
                ㅇ
-->

<!DOCTYPE html>
<html>
<head lang="en">
 <meta charset="UTF-8">
 <link rel="stylesheet" href="./test_css.css">
 <title>drag_test</title>
</head>
<body>
    안녕하세요
    <canvas id="canvas_frame"></canvas>
    <button id="btn_capture">capture</button>


    <script>        //canvas 크기 최대화
        var _canvas;
        _canvas = document.querySelector("#canvas_frame");        
        _canvas.width = window.innerWidth;
        _canvas.height = window.innerHeight;
        console.log("height"+window.innerHeight);
        console.log("width"+window.innerWidth);    
    </script>

    <script>
        var top, left, height, width;
        var json_box = JSON.parse(sessionStorage.getItem('json_box'));
        

        //cavas에 사각형 그리는 코드
        var canvas = document. getElementById ( "canvas_frame" );
        var context = canvas. getContext ( "2d" );

        context.lineWidth = 3; // 컨버스에 그리는 라인의 두께 설정
        context.strokeStyle = "#006cb7"
        var drag = false ;
        canvas.addEventListener ( "mousedown" , function (me) {
            mDown (me)}, false );
        canvas.addEventListener ( "mousemove" , function (me) {
            mMove (me)}, false );
        canvas.addEventListener ( "mouseup" , function (me) {
            mUp (me)}, false );
        canvas.addEventListener ( "mouseout" , function (me) {
            mOut (me)}, false );


        function mMove(me) {
    //drag가 false 일때는 return(return 아래는 실행 안함)
            if (!drag) {
                return ;
            }
            var nowX = me. offsetX ;
            var nowY = me. offsetY ;
            canvasDraw (nowX,nowY);
            stX = nowX;
            stY = nowY;
        }

    function mDown(me) {
        startX = me.offsetX;
        startY = me.offsetY;
        stX = me. offsetX ; //눌렀을 때 현재 마우스 X좌표를 stX에 담음
        stY = me. offsetY ; //눌렀을 때 현재 마우스 Y좌표를 stY에 담음
        drag = true ; //그림 그리기는 그리는 상태로 변경
    }

    function mUp(me) {
        drag = false ; //마우스를 떼었을 때 그리기 중지
    }

    function mOut(me) {
        drag = false ; //마우스가 캔버스 밖으로 벗어났을 때 그리기 중지
    }

    function canvasDraw(currentX,currentY) {

        context.clearRect(0,0,context.canvas.width,context.canvas.height) //설정된 영역만큼 캔버스에서 지움
        context.strokeRect(startX,startY,currentX-startX,currentY-startY) //시작점과 끝점의 좌표 정보로 사각형을 그려준다.
        //json변수에 저장해서 

        top = Math.min(currentY, startY);
        left = Math.min(currentX, startX);
        width = Math.max(currentX, startX) - left;
        height = Math.max(currentY, startY) - top;

    }
    //session 변수값과 로컬 변수화를 동기화
    function set_get_json() {
        sessionStorage.setItem('json_box', JSON.stringify({top_j : top, left_j: left, width_j: width, height_j: height}));
        console.log(JSON.parse(sessionStorage.getItem('json_box')));
        var json_box = JSON.parse(sessionStorage.getItem('json_box'));
        top = json_box.top_j;
        left = json_box.left_j;
        width = json_box.width_j;
        height = json_box.height_j;        
    }


    //canvas에 있는 사각형 움직이는 코드
        var ctx = canvas.getContext("2d");
        var bb = canvas.getBoundingClientRect();
        var startX, startY;
        var iX, iY;
        var isDrag = false;
        
        set_get_json();

        ctx.strokeRect(left, top, width, height );

    // 마우스 버튼 클릭 이벤트 핸들러
    // 박스 위치이면 drag 를 시작한다.
    function mousedown(e) {
        startX = e.clientX - bb.left;
        startY = e.clientY - bb.top;

        if( startX > left && startX < ( left + width ) && startY > top && startY < ( top + width ) ) {
        isDrag = true;
        }
    }

    function mousemove(e) {
      if( isDrag ) {
        iX = e.clientX - bb.left;
        iY = e.clientY - bb.top;

        draw();
        }
    }

    function mouseup(e) {
        if( isDrag ) {
        iX = e.clientX - bb.left;
        iY = e.clientY - bb.top;
        isDrag = false;
        draw();
        }
    }

    // 캔버스의 마우스 이벤트 핸들러 등록
    canvas.addEventListener( "mousemove", mousemove );
    canvas.addEventListener( "mousedown", mousedown );
    canvas.addEventListener( "mouseup", mouseup );

    // 박스를 그린다.
    function draw() {
        left=left + iX - startX;
        top=top + iY - startY;
        ctx.clearRect(0,0,canvas.width,canvas.height);
        ctx.strokeRect( left, top, width, height );

/*         if( isDrag == false ) {
            iLeft = iLeft + iX - startX;
            iTop = iTop + iY - startY;
        } */
    }
</script>

<!-- 
    <script>
        var canvas = document.getElementById ("canvas_frame"); 
        var context = canvas.getContext ("2d");
        var startX, startY, stX, stY;

        var drag = false;

        function mDown(e) {
            startX = e.offsetX;
            startY = e.offsetY;
            stX = e.offsetX;
            stY = e.offsetY;

            drag = true;
        }        

        function mMove(e) {
            if (!drag){
                return ;
            }

            var nowX = e.offsetX;
            var nowY = e.offsetY;

            canvasDraw(nowX,nowY);
            
            stX = nowX;
            stY = nowY;
        }

        function mUp(e) {
            endX = e.offsetX;
            enxY = e.offsetY;

            drag = false;
        }
        function canvasDraw(currentX, currentY) {
            context.clearRect(0,0,context.cavas.width,context.canvas.height);
            context.strokeRect(startX, startY, currentX-startX, currentY-startY);
        }

        function checkBox(e) {

        }
        canvas.addEventListener ( "mousedown" , function (e) {
        mDown (e)}, false );
        canvas.addEventListener ("mouseup", function (e) {
            mUp (e)}, false);
        canvas.addEventListener ("mousemove", function (e) {
            mMove (e)}, false);


    </script>
 -->
 

 
</body>
</html> 
